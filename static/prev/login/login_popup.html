<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì”ë°˜ ì¸¡ì • ì‹œìŠ¤í…œ - ë¡œê·¸ì¸</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:'Noto Sans KR','Malgun Gothic',sans-serif;
            background:linear-gradient(135deg,#56ab2f 0%,#a8e063 100%);
            min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px
        }
        .container{
            background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);
            overflow:hidden;width:100%;max-width:450px
        }
        .header{
            background:linear-gradient(135deg,#56ab2f 0%,#a8e063 100%);color:#fff;padding:40px 30px;text-align:center
        }
        .header h1{font-size:32px;margin-bottom:10px;font-weight:700}
        .header p{font-size:15px;opacity:.95;font-weight:300}
        .tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef}
        .tab{flex:1;padding:18px;text-align:center;cursor:pointer;background:transparent;border:none;font-size:17px;font-weight:600;color:#6c757d;transition:all .3s;position:relative}
        .tab.active{color:#56ab2f;background:#fff}
        .tab.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:3px;background:linear-gradient(90deg,#56ab2f 0%,#a8e063 100%)}
        .form-container{padding:35px 30px}
        .form-group{margin-bottom:22px}
        .form-group label{display:block;margin-bottom:10px;color:#2d3748;font-weight:600;font-size:15px}
        .form-group input{width:100%;padding:14px 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;transition:all .3s;font-family:inherit}
        .form-group input:focus{outline:none;border-color:#56ab2f;box-shadow:0 0 0 3px rgba(86,171,47,.1)}
        .form-group input::placeholder{color:#a0aec0}
        .btn{width:100%;padding:16px;background:linear-gradient(135deg,#56ab2f 0%,#a8e063 100%);color:#fff;border:none;border-radius:10px;font-size:17px;font-weight:700;cursor:pointer;transition:all .3s;box-shadow:0 4px 15px rgba(86,171,47,.3)}
        .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(86,171,47,.4)}
        .btn:active{transform:translateY(0)}
        .alert{padding:14px 16px;border-radius:10px;margin-bottom:20px;display:none;font-size:14px;font-weight:500}
        .alert.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .alert.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
        .alert.show{display:block;animation:slideDown .3s ease}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .form-section{display:none}
        .form-section.active{display:block;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .info-text{text-align:center;color:#718096;font-size:14px;margin-top:18px;font-weight:400}
        .eco-icon{font-size:56px;margin-bottom:15px;text-shadow:2px 2px 4px rgba(0,0,0,.1)}

        /* === ê°œì¸ì •ë³´ ë™ì˜ ëª¨ë‹¬ === */
        .modal-backdrop{
            position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999
        }
        .modal-backdrop.show{display:flex}
        .modal{
            width:100%;max-width:560px;background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden
        }
        .modal-header{
            background:linear-gradient(135deg,#56ab2f 0%,#a8e063 100%);color:#fff;padding:18px 22px
        }
        .modal-header h2{font-size:18px}
        .modal-body{padding:20px 22px;max-height:60vh;overflow:auto}
        .policy-list{font-size:14px;color:#2d3748;line-height:1.6}
        .policy-list li{margin:6px 0 6px 18px}
        .tag-required{display:inline-block;background:#e6f4ea;color:#1e7a2c;border:1px solid #ccebd6;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
        .modal-footer{display:flex;gap:10px;padding:18px 22px;background:#f8fafc;border-top:1px solid #eef2f7}
        .btn-secondary{
            width:auto;padding:12px 16px;background:#e9ecef;color:#2d3748;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s
        }
        .btn-secondary:hover{filter:brightness(.97)}
        .btn-primary{flex:1}
        .consent-check{display:flex;align-items:flex-start;gap:10px;margin:14px 0;color:#2d3748}
        .consent-check input{margin-top:3px}
        .fineprint{font-size:12px;color:#64748b;margin-top:8px}
        .linklike{color:#16794d;text-decoration:underline;cursor:pointer}
        .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    </style>
</head>
<body>
    <div class="container" aria-live="polite">
        <div class="header">
            <div class="eco-icon">ğŸŒ±</div>
            <h1>ì”ë°˜ ì¸¡ì • ì‹œìŠ¤í…œ</h1>
            <p>ì§€êµ¬ë¥¼ ì§€í‚¤ëŠ” ì‘ì€ ì‹¤ì²œ, í•¨ê»˜í•´ìš”</p>
        </div>

        <div class="tabs" role="tablist">
            <button class="tab active" onclick="switchTab(event,'login')" role="tab" aria-selected="true">ë¡œê·¸ì¸</button>
            <button class="tab" onclick="switchTab(event,'register')" role="tab" aria-selected="false">íšŒì›ê°€ì…</button>
        </div>

        <div class="form-container">
            <div id="alert" class="alert" role="status"></div>

            <!-- ë¡œê·¸ì¸ í¼ -->
            <div id="login-form" class="form-section active">
                <form onsubmit="startWithConsent(event, handleLogin)">
                    <div class="form-group">
                        <label for="login-name">ğŸ‘¤ ì´ë¦„</label>
                        <input type="text" id="login-name" placeholder="í™ê¸¸ë™" required autocomplete="name"/>
                    </div>
                    <div class="form-group">
                        <label for="login-phone">ğŸ“± ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="login-phone" placeholder="01012345678" required pattern="[0-9]{10,11}" inputmode="numeric" autocomplete="tel"/>
                    </div>
                    <button type="submit" class="btn">ë¡œê·¸ì¸í•˜ê¸°</button>
                    <p class="info-text">ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¡œ ê°„í¸í•˜ê²Œ ë¡œê·¸ì¸</p>
                </form>
            </div>

            <!-- íšŒì›ê°€ì… í¼ -->
            <div id="register-form" class="form-section" aria-hidden="true">
                <form onsubmit="startWithConsent(event, handleRegister)">
                    <div class="form-group">
                        <label for="register-name">ğŸ‘¤ ì´ë¦„</label>
                        <input type="text" id="register-name" placeholder="í™ê¸¸ë™" required autocomplete="name"/>
                    </div>
                    <div class="form-group">
                        <label for="register-phone">ğŸ“± ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="register-phone" placeholder="01012345678" required pattern="[0-9]{10,11}" inputmode="numeric" autocomplete="tel"/>
                    </div>
                    <div class="form-group">
                        <label for="register-account">ğŸ”‘ ê³„ì¢Œë²ˆí˜¸ ë° ì€í–‰</label>
                        <input type="text" id="register-account" placeholder="(ì€í–‰)ê³„ì¢Œë²ˆí˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥" autocomplete="off"/>
                    </div>
                    <button type="submit" class="btn">ê°€ì…í•˜ê¸°</button>
                    <p class="info-text">ê°€ì… í›„ ë°”ë¡œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                </form>
            </div>
        </div>
    </div>

    <!-- ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ ëª¨ë‹¬ -->
    <div id="consent-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="consent-title" aria-describedby="consent-desc">
        <div class="modal" role="document">
            <div class="modal-header">
                <h2 id="consent-title">[í•„ìˆ˜] ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ <span class="tag-required">í•„ìˆ˜</span></h2>
            </div>
            <div class="modal-body">
                <p id="consent-desc" style="margin-bottom:10px;color:#334155">
                    ë³¸ ìº í˜ì¸ì€ ì°¸ì—¬ í™•ì¸ ë° ê²½í’ˆ ì§€ê¸‰ì„ ìœ„í•´ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘Â·ì´ìš©í•©ë‹ˆë‹¤.
                    ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ì‹œê³  ë™ì˜í•´ ì£¼ì„¸ìš”.
                </p>
                <ul class="policy-list">
                    <li><b>ìˆ˜ì§‘Â·ì´ìš© ëª©ì </b> : ìº í˜ì¸ <b>ì°¸ì—¬ í™•ì¸</b>, <b>ê²½í’ˆ ì§€ê¸‰</b>, <b>ì‚¬í›„ ì„¤ë¬¸ì¡°ì‚¬ ìš”ì²­</b></li>
                    <li><b>ìˆ˜ì§‘ í•­ëª©</b> : ì´ë¦„, ì—°ë½ì²˜(ì „í™”ë²ˆí˜¸), (ì„ íƒ ì…ë ¥ ì‹œ) ê³„ì¢Œ ë° ì€í–‰</li>
                    <li><b>ë³´ìœ Â·ì´ìš© ê¸°ê°„</b> : ìº í˜ì¸ ì¢…ë£Œ í›„ <b>3ê°œì›” ì´ë‚´ íŒŒê¸°</b> (ê´€ë ¨ ë²•ë ¹ì— ë”°ë¼ ë³„ë„ ë³´ê´€ ì‹œ í•´ë‹¹ ê¸°ê°„ ë³´ê´€)</li>
                    <li><b>ì œ3ì ì œê³µ</b> : ì œê³µ ì—†ìŒ (ê²½í’ˆ ë°°ì†¡ ëŒ€í–‰ ë“± ì²˜ë¦¬ë¥¼ ìœ„í•œ ìˆ˜íƒì—…ì²´ ì´ìš© ì‹œ ë³„ë„ ê³ ì§€)</li>
                    <li><b>ë™ì˜ ê±°ë¶€ ê¶Œë¦¬</b> : ë™ì˜ë¥¼ ê±°ë¶€í•  ê¶Œë¦¬ê°€ ìˆìœ¼ë‚˜, ê±°ë¶€ ì‹œ ìº í˜ì¸ ì°¸ì—¬ ë° ê²½í’ˆ ì§€ê¸‰ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                </ul>

                <div class="consent-check">
                    <input type="checkbox" id="consent-check" aria-describedby="consent-desc"/>
                    <label for="consent-check">
                        ìœ„ <b>ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©</b>ì— <b>ë™ì˜</b>í•©ë‹ˆë‹¤. <span class="sr-only">(í•„ìˆ˜)</span>
                    </label>
                </div>

                <div class="fineprint">
                    * ì‚¬í›„ ì„¤ë¬¸ì¡°ì‚¬ ìš”ì²­ì€ ì—°ë½ì²˜ë¡œ ë°œì†¡ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë™ì˜ ì² íšŒëŠ” ì–¸ì œë“ ì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    <span class="linklike" onclick="openPolicy()">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ì „ë¬¸ ë³´ê¸°</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" type="button" onclick="declineConsent()">ë™ì˜í•˜ì§€ ì•ŠìŒ</button>
                <button class="btn btn-primary" type="button" onclick="confirmConsent()">ë™ì˜í•˜ê³  ê³„ì†</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const CONSENT_VERSION = 'v1'; // ì •ì±… ê°œì • ì‹œ ë²„ì „ë§Œ ì˜¬ë¦¬ë©´ ì¬ë™ì˜ ìœ ë„ ê°€ëŠ¥
        let pendingSubmitHandler = null; // ë™ì˜ í›„ ì´ì–´ì„œ ì‹¤í–‰í•  ì½œë°± ì €ì¥

        function switchTab(evt, tab){
            document.querySelectorAll('.tab').forEach(t=>{t.classList.remove('active');t.setAttribute('aria-selected','false')});
            evt.target.classList.add('active'); evt.target.setAttribute('aria-selected','true');

            document.querySelectorAll('.form-section').forEach(f=>f.classList.remove('active'));
            document.getElementById(`${tab}-form`).classList.add('active');

            hideAlert();
        }

        function showAlert(message,type='success'){
            const el=document.getElementById('alert');
            el.textContent=message;
            el.className=`alert ${type} show`;
        }
        function hideAlert(){
            const el=document.getElementById('alert');
            el.classList.remove('show');
        }

        // === ë™ì˜ íë¦„ ===
        function hasConsent(){
            try{
                const saved = JSON.parse(localStorage.getItem('privacyConsentV1'));
                return saved && saved.version === CONSENT_VERSION && saved.accepted === true;
            }catch{ return false; }
        }
        function startWithConsent(event, handler){
            event.preventDefault();
            pendingSubmitHandler = ()=>handler(event);
            if(hasConsent()){
                handler(event);
            }else{
                openConsent();
            }
        }
        function openConsent(){
            const b = document.getElementById('consent-backdrop');
            b.classList.add('show');
            document.getElementById('consent-check').focus();
        }
        function closeConsent(){
            document.getElementById('consent-backdrop').classList.remove('show');
        }
        function confirmConsent(){
            const checked = document.getElementById('consent-check').checked;
            if(!checked){
                showAlert('ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.','error');
                return;
            }
            localStorage.setItem('privacyConsentV1', JSON.stringify({
                version: CONSENT_VERSION,
                accepted: true,
                ts: new Date().toISOString()
            }));
            closeConsent();
            // ë™ì˜ ì™„ë£Œ í›„ ì›ë˜ ë™ì‘ ì´ì–´ê°€ê¸°
            if(typeof pendingSubmitHandler === 'function'){ pendingSubmitHandler(); }
        }
        function declineConsent(){
            closeConsent();
            showAlert('ë™ì˜í•˜ì§€ ì•Šì•„ ì§„í–‰ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.','error');
            pendingSubmitHandler = null;
        }
        function openPolicy(){
            // ì‹¤ì œ ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ URLë¡œ êµì²´í•˜ì„¸ìš”
            alert('ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤. (URL ì—°ê²° í•„ìš”)');
            // window.open('/privacy-policy','_blank');
        }

        // === ì‹¤ì œ ë¡œê·¸ì¸ ì²˜ë¦¬ ===
        async function handleLogin(event){
            // eventëŠ” ì´ë¯¸ preventDefault ìƒíƒœ
            const name = document.getElementById('login-name').value.trim();
            const phoneNum = document.getElementById('login-phone').value.replace(/[^0-9]/g,'');

            if(phoneNum.length<10 || phoneNum.length>11){
                showAlert('ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');
                return;
            }

            try{
                const response = await fetch(`${API_BASE}/api/login/with-name`,{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        name, phoneNum,
                        // ë°±ì—”ë“œ ê²€ì¦ì´ í•„ìš”í•˜ë©´ ì•„ë˜ ë™ì˜ í”Œë˜ê·¸ë¥¼ í•¨ê»˜ ì „ë‹¬
                        privacyConsent:true, consentVersion:CONSENT_VERSION
                    })
                });
                const data = await response.json();
                if(response.ok){
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user_name', name);
                    showAlert('âœ… ë¡œê·¸ì¸ ì„±ê³µ! ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...','success');
                    setTimeout(()=>{ window.location.href='/' }, 800);
                }else{
                    showAlert('âŒ '+(data.detail||'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'),'error');
                }
            }catch(err){
                showAlert('âŒ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error');
                console.error('Login error:', err);
            }
        }

        // === íšŒì›ê°€ì… ì²˜ë¦¬ ===
        async function handleRegister(event){
            const name = document.getElementById('register-name').value.trim();
            const phoneNum = document.getElementById('register-phone').value.replace(/[^0-9]/g,'');
            const accountId = document.getElementById('register-account').value.trim() || ('user_'+Date.now());

            if(phoneNum.length<10 || phoneNum.length>11){
                showAlert('ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');
                return;
            }

            try{
                // 1) ê°€ì…
                const registerResponse = await fetch(`${API_BASE}/api/register`,{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        name, phoneNum, accountId,
                        privacyConsent:true, consentVersion:CONSENT_VERSION
                    })
                });
                const registerData = await registerResponse.json();

                if(registerResponse.ok){
                    showAlert('âœ… íšŒì›ê°€ì… ì„±ê³µ! ìë™ ë¡œê·¸ì¸ ì¤‘...','success');

                    // 2) ìë™ ë¡œê·¸ì¸
                    const loginResponse = await fetch(`${API_BASE}/api/login/with-name`,{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({ name, phoneNum })
                    });
                    const loginData = await loginResponse.json();
                    if(loginResponse.ok){
                        localStorage.setItem('access_token', loginData.access_token);
                        localStorage.setItem('user_name', name);
                        window.location.href='/';
                    }else{
                        showAlert('âŒ ìë™ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.','error');
                    }
                }else{
                    showAlert('âŒ '+(registerData.detail||'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'),'error');
                }
            }catch(err){
                showAlert('âŒ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.','error');
                console.error('Register error:', err);
            }
        }

        // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ë©”ì¸ìœ¼ë¡œ ì´ë™
        window.addEventListener('DOMContentLoaded', ()=>{
            const token = localStorage.getItem('access_token');
            if(token){ window.location.href='/'; }
        });
    </script>
</body>
</html>
